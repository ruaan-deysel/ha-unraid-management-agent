name: CI

on:
  push:
    branches:
      - main
      - enhancement/*
      - feature/*
      - fix/*
  pull_request:
    branches:
      - main

# Minimal permissions for security
permissions:
  contents: read

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install ruff

      - name: Run Ruff format check
        run: ruff format --check .

      - name: Run Ruff linter
        run: ruff check .

  test:
    name: Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install homeassistant>=2026.1.0
          pip install pytest>=8.0.0 pytest-asyncio>=0.23.0 pytest-homeassistant-custom-component>=0.13.0
          pip install pytest-cov>=4.0.0 pytest-timeout>=2.0.0
          pip install uma-api[async]>=1.2.0

      - name: Run tests with coverage
        run: |
          pytest \
            --cov \
            --cov-branch \
            --cov-report=xml \
            --cov-report=term-missing \
            -v

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          files: ./coverage.xml
          fail_ci_if_error: false

  validate:
    name: Validate
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate manifest.json
        run: |
          python3 << 'EOF'
          import json
          import sys

          with open('custom_components/unraid_management_agent/manifest.json') as f:
              manifest = json.load(f)

          required = ['domain', 'name', 'version', 'documentation', 'issue_tracker', 'requirements', 'codeowners']
          missing = [field for field in required if field not in manifest]

          if missing:
              print(f'❌ Missing required fields: {missing}')
              sys.exit(1)

          print(f'✅ manifest.json valid - {manifest["name"]} v{manifest["version"]}')
          EOF

      - name: Validate strings.json
        run: python3 -c "import json; json.load(open('custom_components/unraid_management_agent/strings.json')); print('✅ strings.json valid')"

      - name: Check required files
        run: |
          for file in __init__.py manifest.json strings.json config_flow.py const.py; do
            test -f "custom_components/unraid_management_agent/$file" || { echo "❌ Missing: $file"; exit 1; }
          done
          echo "✅ All required files present"
